SELECT upc FROM ( SELECT upc, description, category, revenue, DENSE_RANK() OVER (PARTITION BY category ORDER BY revenue DESC) catRank FROM ( SELECT p.upc upc, p.description description, p.categorySubDescription category, SUM(li.extendedAmount*li.quantity) revenue FROM [views.LineItem] li JOIN [views.Product] p ON li.itemId = p.upc  JOIN ( SELECT p.categorySubDescription category, SUM(li.extendedAmount*li.quantity) revenue, FROM [views.LineItem] li JOIN [views.Product] p ON li.itemId = p.upc GROUP BY 1 ORDER BY 2 DESC LIMIT 25) c ON p.categorySubDescription = c.category GROUP BY 1,2,3 ORDER BY 4 DESC ) ) WHERE catRank <= 2

